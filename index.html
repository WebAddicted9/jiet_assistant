<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JIET Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Use Inter font for the entire application */
        body,
        input,
        button {
            font-family: 'Inter', sans-serif;
        }

        /* Custom scrollbar for a more polished look */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #e2e8f0;
            /* bg-gray-200 */
            border-radius: 10px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #94a3b8;
            /* bg-slate-400 */
            border-radius: 10px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #64748b;
            /* bg-slate-500 */
        }

        /* Simple fade-in animation for messages */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message {
            animation: fadeIn 0.4s ease-in-out;
        }

        /* Typing indicator animation */
        .dot-flashing {
            position: relative;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #475569;
            /* slate-600 */
            color: #475569;
            animation: dotFlashing 1s infinite linear alternate;
            animation-delay: .5s;
        }

        .dot-flashing::before,
        .dot-flashing::after {
            content: '';
            display: inline-block;
            position: absolute;
            top: 0;
        }

        .dot-flashing::before {
            left: -15px;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #475569;
            color: #475569;
            animation: dotFlashing 1s infinite alternate;
            animation-delay: 0s;
        }

        .dot-flashing::after {
            left: 15px;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #475569;
            color: #475569;
            animation: dotFlashing 1s infinite alternate;
            animation-delay: 1s;
        }

        ul {
            list-style-type: disc;
            padding-left: 20px;
        }

        @keyframes dotFlashing {
            0% {
                background-color: #475569;
            }

            50%,
            100% {
                background-color: #cbd5e1;
            }

            /* slate-300 */
        }

        /* Specific styles for the information card */
        .course-card {
            /* Renamed from info-card for consistency with your existing styles */
            background-color: #f8fafc;
            /* slate-50 */
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            margin-top: 0.5rem;
            /* Adjusted margin to fit within message bubble */
            max-width: 400px;
            /* Adjust as needed */
        }

        .course-card-image {
            width: 100%;
            height: 180px;
            /* Fixed height for consistency */
            object-fit: cover;
            border-bottom: 1px solid #e2e8f0;
            /* slate-200 */
        }

        .course-card-content {
            padding: 1rem;
        }

        .course-card-buttons {
            display: flex;
            gap: 0.75rem;
            padding: 1rem;
            border-top: 1px solid #e2e8f0;
            /* slate-200 */
        }

        .course-card-buttons button,
        .course-card-buttons a {
            flex: 1;
            padding: 0.75rem 0.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            text-align: center;
            text-decoration: none;
            /* For <a> tags */
            display: inline-block;
            /* For <a> tags */
        }

        .course-card-buttons .contact-btn {
            background-color: #6366f1;
            /* indigo-500 */
            color: white;
        }

        .course-card-buttons .contact-btn:hover {
            background-color: #4f46e5;
            /* indigo-600 */
            transform: translateY(-1px);
        }

        .course-card-buttons .know-more-btn {
            background-color: #e0e7ff;
            /* indigo-100 */
            color: #4f46e5;
            /* indigo-600 */
            border: 1px solid #c7d2fe;
            /* indigo-200 */
        }

        .course-card-buttons .know-more-btn:hover {
            background-color: #c7d2fe;
            /* indigo-200 */
            transform: translateY(-1px);
        }

        /* Styles for quick reply chips */
        .quick-reply-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
            max-width: 85%;
            /* Match chat bubble width */
        }

        .quick-reply-chip {
            background-color: #e0e7ff;
            /* indigo-100 */
            color: #4f46e5;
            /* indigo-600 */
            padding: 0.6rem 1rem;
            border-radius: 9999px;
            /* Pill shape */
            cursor: pointer;
            font-size: 0.875rem;
            /* text-sm */
            font-weight: 500;
            /* font-medium */
            transition: all 0.2s ease-in-out;
            border: 1px solid #c7d2fe;
            /* indigo-200 */
        }

        .quick-reply-chip:hover {
            background-color: #c7d2fe;
            /* indigo-200 */
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>

<body class="bg-slate-200 flex items-center justify-center min-h-screen p-4">

    <div
        class="chatbot-container bg-white rounded-2xl shadow-2xl w-full max-w-2xl flex flex-col h-[90vh] max-h-[700px]">

        <div
            class="chatbot-header bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 flex items-center justify-between rounded-t-2xl shadow-lg flex-shrink-0">
            <div class="flex items-center space-x-3">
                <img src="https://www.jietjodhpur.ac.in/assets/images/logo.png" alt="JIET Logo" class="h-10 w-10"
                    onerror="this.style.display='none'">
                <div>
                    <h1 class="text-xl font-bold">JIET Assistant</h1>
                    <p class="text-xs opacity-80">Your guide to JIET Universe</p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <span class="relative flex h-3 w-3">
                    <span
                        class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-300 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-3 w-3 bg-green-400"></span>
                </span>
                <span class="text-sm font-medium">Online</span>
            </div>
        </div>

        <div id="chat-messages" class="chat-messages flex-1 p-6 overflow-y-auto space-y-4 bg-slate-50">
            <div class="message flex">
                <div class="flex-shrink-0">
                    <div
                        class="h-8 w-8 rounded-full bg-indigo-500 flex items-center justify-center text-white font-bold text-sm">
                        AI</div>
                </div>
                <div class="ml-3 bg-white text-slate-800 p-3 rounded-lg rounded-tl-none shadow-md max-w-[85%]">
                    <p>Hello! I am the JIET Assistant. I can answer your questions about admissions, courses, fees,
                        placements, and campus life at JIET Universe. How can I help you today?</p>
                </div>
            </div>
        </div>

        <div class="message-input-area p-4 bg-white border-t border-slate-200 flex items-center space-x-3">
            <input type="text" id="user-input" placeholder="Ask about courses, fees, placements..."
                class="flex-1 p-3 border border-slate-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200 ease-in-out text-slate-800">
            <button id="send-button"
                class="bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
                </svg>
            </button>
        </div>
    </div>

    <script>
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        let chatHistory = [];

        // --- GLOBAL STATE FOR COURSE SELECTION ---
        let currentCourseSelectionStage = null; // 'awaiting_course_type', 'awaiting_btech_specialization' etc.
        let selectedCourseType = null; // Stores the main course, e.g., 'B.Tech'
        let detectedUserLanguage = "english"; // Default language

        // --- KNOWLEDGE BASE ---
        const jietKnowledgeBase = `
        # JIET Universe: An In-Depth Institutional Analysis for Digital Integration
        ## Section 1: JIET Universe: An Institutional Profile
        Established in 2003, the Jodhpur Institute of Engineering and Technology Group of Institutions (JIET Universe) is a private, autonomous educational group in Jodhpur, Rajasthan. It is recognized by UGC and AICTE, and holds an 'A' Grade from NAAC. Key engineering branches are NBA accredited, making students eligible for opportunities in Europe and America. The main campus is on the Jodhpur-Pali Highway (NH-62).
        The JIET Universe ecosystem includes: Jodhpur Institute of Engineering and Technology (JIET), JIET Institute of Design and Technology (JIETDAT), JIET College of Nursing (JIETCON), Jodhpur Institute of Hotel Management (JIHM), JIET College of Pharmacy, and JIET Medical College and Hospital.
        Programs are affiliated with Bikaner Technical University (BTU), Rajasthan University of Health Sciences (RUHS), and NCHMCT. The medical program is regulated by NMC/MCI.
        Contact: Address: JIET Universe, NH-62, Jodhpur Pali Highway, Village Mogra, Jodhpur - 342802. Phone: +91-291-2868152, +91-9773378530. Email: info@jietjodhpur.ac.in. Website: jietjodhpur.ac.in.
        ## Section 2: Academic Programs
        JIET offers UG, PG, diploma, and doctoral programs using a Choice Based Credit System (CBCS).
        - B.Tech (4 Yrs): CSE, AI & ML, Data Science, Cyber Security, ECE, EE, ME, CE, VLSI, Robotics.
        - MBBS (5.5 Yrs): At JIET Medical College & Hospital.
        - B.Des (4 Yrs): Fashion Design, Interior Design.
        - MBA (2 Yrs): Finance, HR, Marketing, Agri-Business, Business Intelligence.
        - MCA (2 Yrs): Full Stack Dev, AI, Machine Learning.
        - M.Tech (2 Yrs): Various specializations.
        ## Section 3: Admissions (2025-26 Cycle)
        Admissions are primarily online. Selection is based on national/state entrance exams.
        - B.Tech: JEE Main or REAP. Eligibility: 10+2 with PCM (min. 45%).
        - MBA: CAT / MAT / XAT / CMAT / ATMA. Eligibility: Graduation (min. 50%).
        - MBBS: NEET UG.
        ## Section 4: Fees and Scholarships (2025-26)
        ### 4.1 Program-Wise Fee Structures
        - B.Tech (1st Year): ~₹1,44,884.
        - MBA/MCA (1st Year): ~₹1,27,206.
        - BBA/BCA (1st Year): ~₹85,900.
        - Hostel (Annual): AC Double Seater: ₹1,50,000. Air Cooled Double Seater: ₹99,000.
        ### 4.2 Institutional Scholarship Details
        JIET offers a structured scholarship program. The benefits vary by course and performance.
        - **B.Tech (CSE, AI & ML, Data Science, Cyber Security):**
          - Eligibility: >=90% in Class 12th -> Scholarship: ₹15,000 (One-time, 1st Year).
          - Eligibility: >=90 Percentile in JEE Main -> Scholarship: ₹25,000 (One-time, 1st Year).
        - **B.Tech (ME, CE, EE, ECE):**
          - Eligibility: >=60% in Class 12th -> Scholarship: ₹40,000 (All Four Years).
          - Eligibility: <60% in Class 12th -> Scholarship: ₹25,000 (All Four Years).
        - **B.Des:**
          - Eligibility: >=60% in Class 12th -> Scholarship: ₹40,000 (All Four Years).
          - Eligibility: <60% in Class 12th -> Scholarship: ₹25,000 (All Four Years).
        - **BBA / BCA:**
          - Eligibility: >=60% in Class 12th -> Scholarship: ₹25,000 (All Three Years).
          - Eligibility: <60% in Class 12th -> Scholarship: ₹15,000 (All Three Years).
        - **MBA / MCA:**
          - Eligibility: >=80% in Graduation -> Scholarship: ₹15,000 (One-time, 1st Year).
        - **M.Tech:**
          - All admitted students receive a ₹25,000 scholarship for both years.
        - **B.Tech (Lateral Entry):**
          - All admitted students receive a ₹25,000 scholarship for all three years.
        - **B.Sc (H&HA):**
          - Eligibility: >=60% in Class 12th -> Scholarship: ₹40,000 (All Three Years).
          - Eligibility: <60% in Class 12th -> Scholarship: ₹25,000 (All Three Years).
        Note: Students can typically avail only one scholarship, whichever is higher.
        ## Section 5: Placements and Career Trajectories
        JIET has a proactive Career Development Cell (CDC) that facilitates placements. The placement statistics can vary by source, so it's best to consider a range.
        - **Highest Salary Package:** The official website reports a highest package of ₹33 LPA for the 2023 batch. However, other sources report figures ranging from ₹11 LPA to ₹18 LPA for recent years. These top packages are often secured by a few high-achieving students.
        - **Average Salary Package:** Most sources place the average package in the range of ₹4.5 LPA to ₹7 LPA. For the majority of students, a typical offer from on-campus drives is in this range.
        - **Placement Rate:** The overall placement rate is consistently high, generally reported between 80% and 90%.
        - **Department-wise Average Packages (Approx. for 2024):**
          - CSE: ~₹5.66 LPA
          - AI & ML: ~₹5.35 LPA
          - MBA: ~₹5.32 LPA
          - Data Science: ~₹5.21 LPA
          - Mechanical & Civil: ~₹4.6 LPA
          - ECE & EE: ~₹4.15 LPA
        - **Key Recruiters:**
          - **Mass Recruiters:** TCS, Infosys, Wipro, Capgemini, and Cognizant form the backbone of the placement drives, making a high volume of offers.
          - **Other Prominent Recruiters:** Celebal Technologies, Tekion, Synopsys, MediaAMP, Wonder Cement, ICICI Bank, Optum, Bajaj Finserv, Reliance Jio, and many others also recruit from campus.
        ## Section 6: Campus Life
        45-acre campus with hostels, library, hospital, auditorium, transport fleet, and various student clubs.
        ### 6.2.2 Student Clubs and Societies
        JIET encourages a vibrant campus life through a wide array of student-run clubs catering to diverse interests.
        - **HACKATHON CLUB:** Fosters a culture of competitive programming and problem-solving through hackathons and coding events.
        - **ANDROID DEVELOPMENT CLUB:** A hub for mobile app enthusiasts to learn, build, and deploy Android applications.
        - **PHOTOGRAPHY CLUB:** For students passionate about capturing moments, learning photography techniques, and visual storytelling.
        - **MAD. D CLUB (Music and Dance):** The official platform for performing arts, allowing students to express their talents in music and dance.
        - **SPORTS CLUB:** Promotes physical fitness and sportsmanship through various indoor and outdoor sports activities and tournaments.
        - **EDC CLUB (Entrepreneurship Development Cell):** Aims to nurture entrepreneurial skills and support students with innovative business ideas.
        - **GAME DEVELOPMENT CLUB:** Focuses on the art and science of game creation, using engines like Unity 3D and programming languages like C#.
        - **DEVELOPER STUDENT CLUB (DSC):** A Google Developers sponsored program for students to learn about mobile and web development, machine learning, and cloud computing.
        - **NSS CLUB (National Service Scheme):** A community service-oriented group that engages in social outreach and volunteer activities.
        - **NCC (National Cadet Corps):** A uniformed youth wing offering basic military training and fostering discipline, leadership, and patriotism.
        - **ROBOTIC CLUB:** An active club for students interested in robotics, automation, and mechatronics, conducting workshops on technologies like Arduino and organizing project competitions.
        `;

        // Course Data for Quick Replies and detailed info
        const courseData = {
            "B.Tech": {
                "english": {
                    "intro": "B.Tech is a 4-year undergraduate engineering program. We offer the following specializations:",
                    "fees": "~₹1,44,884 (1st Year)",
                    "eligibility": "10+2 with PCM (min. 45%), JEE Main or REAP.",
                    "placements": {
                        "CSE": "~₹5.66 LPA (avg)",
                        "AI & ML": "~₹5.35 LPA (avg)",
                        "Data Science": "~₹5.21 LPA (avg)",
                        "Cyber Security": "Similar to CSE/AI&ML (avg)",
                        "ECE": "~₹4.15 LPA (avg)",
                        "EE": "~₹4.15 LPA (avg)",
                        "ME": "~₹4.6 LPA (avg)",
                        "CE": "~₹4.6 LPA (avg)",
                        "VLSI": "Emerging specialization, good prospects.",
                        "Robotics": "Emerging specialization, good prospects."
                    }
                },
                "hindi": {
                    "intro": "बी.टेक 4 साल का अंडरग्रेजुएट इंजीनियरिंग प्रोग्राम है। हम निम्नलिखित विशेषज्ञताएँ प्रदान करते हैं:",
                    "fees": "~₹1,44,884 (पहला साल)",
                    "eligibility": "10+2 पीसीएम के साथ (न्यूनतम 45%), जेईई मेन या रीएपी।",
                    "placements": {
                        "CSE": "~₹5.66 LPA (औसत)",
                        "AI & ML": "~₹5.35 LPA (औसत)",
                        "Data Science": "~₹5.21 LPA (औसत)",
                        "Cyber Security": "सीएसई/एआई और एमएल के समान (औसत)",
                        "ECE": "~₹4.15 LPA (औसत)",
                        "EE": "~₹4.15 LPA (औसत)",
                        "ME": "~₹4.6 LPA (औसत)",
                        "CE": "~₹4.6 LPA (औसत)",
                        "VLSI": "उभरती हुई विशेषज्ञता, अच्छे अवसर।",
                        "Robotics": "उभरती हुई विशेषज्ञता, अच्छे अवसर।"
                    }
                },
                "hinglish": {
                    "intro": "B.Tech ek 4 saal ka undergraduate engineering program hai. Hum ye specializations offer karte hain:",
                    "fees": "~₹1,44,884 (1st Year)",
                    "eligibility": "10+2 with PCM (min. 45%), JEE Main ya REAP.",
                    "placements": {
                        "CSE": "~₹5.66 LPA (avg)",
                        "AI & ML": "~₹5.35 LPA (avg)",
                        "Data Science": "~₹5.21 LPA (avg)",
                        "Cyber Security": "CSE/AI&ML ke jaisa (avg)",
                        "ECE": "~₹4.15 LPA (avg)",
                        "EE": "~₹4.15 LPA (avg)",
                        "ME": "~₹4.6 LPA (avg)",
                        "CE": "~₹4.6 LPA (avg)",
                        "VLSI": "Emerging specialization hai, ache prospects hain.",
                        "Robotics": "Emerging specialization hai, ache prospects hain."
                    }
                },
                "specializations": ["CSE", "AI & ML", "Data Science", "Cyber Security", "ECE", "EE", "ME", "CE", "VLSI", "Robotics", "Lateral Entry"]
            },
            "MBA": {
                "english": {
                    "intro": "MBA is a 2-year postgraduate program. Specializations include Finance, HR, Marketing, Agri-Business, and Business Intelligence.",
                    "fees": "~₹1,27,206 (1st Year)",
                    "eligibility": "Graduation (min. 50%), CAT / MAT / XAT / CMAT / ATMA.",
                    "placements": "~₹5.32 LPA (avg)"
                },
                "hindi": {
                    "intro": "एमबीए 2 साल का पोस्टग्रेजुएट प्रोग्राम है। विशेषज्ञता में वित्त, मानव संसाधन, विपणन, कृषि-व्यवसाय और व्यावसायिक बुद्धिमत्ता शामिल हैं।",
                    "fees": "~₹1,27,206 (पहला साल)",
                    "eligibility": "स्नातक (न्यूनतम 50%), कैट / मैट / एक्सएटी / सीमैट / आत्मा।",
                    "placements": "~₹5.32 LPA (औसत)"
                },
                "hinglish": {
                    "intro": "MBA ek 2 saal ka postgraduate program hai. Specializations mein Finance, HR, Marketing, Agri-Business, aur Business Intelligence shamil hain.",
                    "fees": "~₹1,27,206 (1st Year)",
                    "eligibility": "Graduation (min. 50%), CAT / MAT / XAT / CMAT / ATMA.",
                    "placements": "~₹5.32 LPA (avg)"
                }
            },
            "MCA": {
                "english": {
                    "intro": "MCA is a 2-year postgraduate program. Specializations include Full Stack Dev, AI, and Machine Learning.",
                    "fees": "~₹1,27,206 (1st Year)",
                    "eligibility": "Graduation (min. 50%).",
                    "placements": "Strong placements, especially in AI/ML."
                },
                "hindi": {
                    "intro": "एमसीए 2 साल का पोस्टग्रेजुएट प्रोग्राम है। विशेषज्ञता में फुल स्टैक देव, एआई और मशीन लर्निंग शामिल हैं।",
                    "fees": "~₹1,27,206 (पहला साल)",
                    "eligibility": "स्नातक (न्यूनतम 50%)।",
                    "placements": "मजबूत प्लेसमेंट, विशेष रूप से एआई/एमएल में।"
                },
                "hinglish": {
                    "intro": "MCA ek 2 saal ka postgraduate program hai. Specializations mein Full Stack Dev, AI, aur Machine Learning shamil hain.",
                    "fees": "~₹1,27,206 (1st Year)",
                    "eligibility": "Graduation (min. 50%).",
                    "placements": "Strong placements hain, specially AI/ML mein."
                }
            },
            "MBBS": {
                "english": {
                    "intro": "MBBS is a 5.5-year medical program at JIET Medical College & Hospital.",
                    "fees": "Please refer to the official medical college website for detailed fee structure as it varies.",
                    "eligibility": "NEET UG."
                },
                "hindi": {
                    "intro": "एमबीबीएस JIET मेडिकल कॉलेज और अस्पताल में 5.5 साल का मेडिकल प्रोग्राम है।",
                    "fees": "विस्तृत शुल्क संरचना के लिए कृपया आधिकारिक मेडिकल कॉलेज वेबसाइट देखें क्योंकि यह अलग-अलग होती है।",
                    "eligibility": "नीट यूजी।"
                },
                "hinglish": {
                    "intro": "MBBS ek 5.5 saal ka medical program hai JIET Medical College & Hospital mein.",
                    "fees": "Detailed fees ke liye please official medical college website check karein kyunki yeh vary karta hai.",
                    "eligibility": "NEET UG."
                }
            },
            "B.Des": {
                "english": {
                    "intro": "B.Des (Bachelor of Design) is a 4-year program with specializations in Fashion Design and Interior Design.",
                    "fees": "Approx. ₹85,900 (1st Year)", // Placeholder, adjust if specific B.Des fees are available
                    "eligibility": "10+2 with min. 60%."
                },
                "hindi": {
                    "intro": "बी.डेस (बैचलर ऑफ डिजाइन) फैशन डिजाइन और इंटीरियर डिजाइन में विशेषज्ञता के साथ 4 साल का कार्यक्रम है।",
                    "fees": "लगभग ₹85,900 (पहला साल)",
                    "eligibility": "10+2 न्यूनतम 60% के साथ।"
                },
                "hinglish": {
                    "intro": "B.Des (Bachelor of Design) ek 4 saal ka program hai Fashion Design aur Interior Design specializations ke saath.",
                    "fees": "Approx. ₹85,900 (1st Year)",
                    "eligibility": "10+2 with min. 60%."
                }
            },
            "M.Tech": {
                "english": {
                    "intro": "M.Tech is a 2-year postgraduate program. All admitted M.Tech students receive a ₹25,000 scholarship for both years.",
                    "fees": "Please contact the admissions office for specific M.Tech fees.",
                    "eligibility": "Relevant B.Tech degree."
                },
                "hindi": {
                    "intro": "एम.टेक 2 साल का पोस्टग्रेजुएट प्रोग्राम है। सभी प्रवेश प्राप्त एम.टेक छात्रों को दोनों वर्षों के लिए ₹25,000 की छात्रवृत्ति मिलती है।",
                    "fees": "विशिष्ट एम.टेक शुल्क के लिए प्रवेश कार्यालय से संपर्क करें।",
                    "eligibility": "संबंधित बी.टेक डिग्री।"
                },
                "hinglish": {
                    "intro": "M.Tech ek 2 saal ka postgraduate program hai. Sabhi admitted M.Tech students ko dono saalon ke liye ₹25,000 scholarship." ,
                    "fees": "M.Tech ki specific fees ke liye admissions office se contact karein.",
                    "eligibility": "Relevant B.Tech degree."
                }
            },
            "BBA": {
                "english": {
                    "intro": "BBA (Bachelor of Business Administration) is a popular undergraduate program.",
                    "fees": "~₹85,900 (1st Year)",
                    "eligibility": "10+2 with min. 60%."
                },
                "hindi": {
                    "intro": "बीबीए (बैचलर ऑफ बिजनेस एडमिनिस्ट्रेशन) एक लोकप्रिय स्नातक कार्यक्रम है।",
                    "fees": "~₹85,900 (पहला साल)",
                    "eligibility": "10+2 न्यूनतम 60% के साथ।"
                },
                "hinglish": {
                    "intro": "BBA (Bachelor of Business Administration) ek popular undergraduate program hai.",
                    "fees": "~₹85,900 (1st Year)",
                    "eligibility": "10+2 with min. 60%."
                }
            },
            "BCA": {
                "english": {
                    "intro": "BCA (Bachelor of Computer Applications) is an undergraduate program focused on computer applications.",
                    "fees": "~₹85,900 (1st Year)",
                    "eligibility": "10+2 with min. 60%."
                },
                "hindi": {
                    "intro": "बीसीए (बैचलर ऑफ कंप्यूटर एप्लीकेशन) कंप्यूटर एप्लीकेशन पर केंद्रित एक स्नातक कार्यक्रम है।",
                    "fees": "~₹85,900 (पहला साल)",
                    "eligibility": "10+2 न्यूनतम 60% के साथ।"
                },
                "hinglish": {
                    "intro": "BCA (Bachelor of Computer Applications) ek undergraduate program hai jo computer applications par focus karta hai.",
                    "fees": "~₹85,900 (1st Year)",
                    "eligibility": "10+2 with min. 60%."
                }
            },
            "B.Sc (H&HA)": {
                "english": {
                    "intro": "B.Sc in Hospitality & Hotel Administration (H&HA) is offered at Jodhpur Institute of Hotel Management (JIHM).",
                    "fees": "Please contact JIHM for specific fees.",
                    "eligibility": "10+2 with min. 60%."
                },
                "hindi": {
                    "intro": "बी.एससी हॉस्पिटैलिटी एंड होटल एडमिनिस्ट्रेशन (H&HA) जोधपुर इंस्टीट्यूट ऑफ होटल मैनेजमेंट (JIHM) में पेश किया जाता है।",
                    "fees": "विशिष्ट शुल्क के लिए JIHM से संपर्क करें।",
                    "eligibility": "10+2 न्यूनतम 60% के साथ।"
                },
                "hinglish": {
                    "intro": "B.Sc in Hospitality & Hotel Administration (H&HA) Jodhpur Institute of Hotel Management (JIHM) mein offer kiya jata hai.",
                    "fees": "Specific fees ke liye JIHM se contact karein.",
                    "eligibility": "10+2 with min. 60%."
                }
            },
            "Diploma": {
                "english": {
                    "intro": "JIET also offers various Diploma programs. Please visit the official website or contact admissions for details.",
                    "fees": "Varies by program.",
                    "eligibility": "Varies by program."
                },
                "hindi": {
                    "intro": "JIET विभिन्न डिप्लोमा कार्यक्रम भी प्रदान करता है। विवरण के लिए कृपया आधिकारिक वेबसाइट पर जाएं या प्रवेश कार्यालय से संपर्क करें।",
                    "fees": "कार्यक्रम के अनुसार भिन्न होता है।",
                    "eligibility": "कार्यक्रम के अनुसार भिन्न होता है।"
                },
                "hinglish": {
                    "intro": "JIET kai Diploma programs bhi offer karta hai. Details ke liye official website visit karein ya admissions contact karein.",
                    "fees": "Program ke hisab se vary karta hai.",
                    "eligibility": "Program ke hisab se vary karta hai."
                }
            },
            "Doctoral": {
                "english": {
                    "intro": "JIET offers Doctoral (Ph.D.) programs. For specific details on specializations, eligibility, and admission process, please contact the research department.",
                    "fees": "Varies by program.",
                    "eligibility": "Varies by program."
                },
                "hindi": {
                    "intro": "JIET डॉक्टरेट (पीएच.डी.) कार्यक्रम प्रदान करता है। विशेषज्ञताओं, पात्रता और प्रवेश प्रक्रिया के विशिष्ट विवरण के लिए, कृपया अनुसंधान विभाग से संपर्क करें।",
                    "fees": "कार्यक्रम के अनुसार भिन्न होता है।",
                    "eligibility": "कार्यक्रम के अनुसार भिन्न होता है।"
                },
                "hinglish": {
                    "intro": "JIET Doctoral (Ph.D.) programs offer karta hai. Specializations, eligibility, aur admission process ke detailed info ke liye, please research department se contact karein.",
                    "fees": "Program ke hisab se vary karta hai.",
                    "eligibility": "Program ke hisab se vary karta hai."
                }
            }
        };

        const mainCourseTypes = ["B.Tech", "MBA", "MCA", "MBBS", "B.Des", "M.Tech", "BBA", "BCA", "B.Sc (H&HA)", "Diploma", "Doctoral"];

        // --- NEW: JIET Card Data ---
        const jietCardData = {
            "courses": {
                "english": {
                    // FIX: Changed imageUrl to a working link
                    imageUrl: "images/course.webp", // Corrected image URL
                    title: "Courses Offered at JIET",
                    description: "Hey there! We offer a variety of programs at JIET Universe, from undergraduate to doctoral degrees. Which type of course are you interested in? You can select from the options below:",
                    button1Text: "Contact Details",
                    button1Link: "tel:+919773378530",
                    button2Text: "Know More",
                    button2Link: "https://www.jietjodhpur.ac.in/academics/courses"
                },
                "hindi": {
                    // FIX: Changed imageUrl to a working link
                    imageUrl: "images/course.webp", // Corrected image URL
                    title: "JIET में उपलब्ध पाठ्यक्रम",
                    description: "नमस्ते! हम JIET यूनिवर्स में स्नातक से डॉक्टरेट तक कई तरह के कार्यक्रम पेश करते हैं। आप किस प्रकार के पाठ्यक्रम में रुचि रखते हैं? आप नीचे दिए गए विकल्पों में से चुन सकते हैं:",
                    button1Text: "संपर्क विवरण",
                    button1Link: "tel:+919773378530",
                    button2Text: "अधिक जानें",
                    button2Link: "https://www.jietjodhpur.ac.in/academics/courses"
                },
                "hinglish": {
                    // FIX: Changed imageUrl to a working link
                    imageUrl: "images/course.webp", // Corrected image URL
                    title: "JIET mein Courses Available",
                    description: "Hey there! Hum JIET Universe mein undergraduate se doctoral tak kayi tarah ke programs offer karte hain. Aap kis type ke course mein interested ho? Neeche diye gaye options mein se select kar sakte ho:",
                    button1Text: "Contact Details",
                    button1Link: "tel:+919773378530",
                    button2Text: "Know More",
                    button2Link: "https://www.jietjodhpur.ac.in/academics/courses"
                }
            },
            "placements": {
                "english": {
                    imageUrl: "https://www.jietjodhpur.ac.in/assets/images/placement_img.jpg", // Example: Replace with an actual placement image URL from JIET
                    title: "JIET Placements & Career Opportunities",
                    description: "JIET's Career Development Cell (CDC) is very active in ensuring great placement opportunities for our students. For more details, you can view our placement report or contact the CDC.",
                    button1Text: "Contact CDC",
                    button1Link: "tel:+91-9876543210", // Example: Replace with actual CDC contact
                    button2Text: "View Placement Report",
                    button2Link: "https://www.jietjodhpur.ac.in/placements" // Example: Replace with actual placement report link
                },
                "hindi": {
                    imageUrl: "https://www.jietjodhpur.ac.in/assets/images/placement_img.jpg",
                    title: "JIET प्लेसमेंट और करियर के अवसर",
                    description: "JIET का करियर डेवलपमेंट सेल (सीडीसी) हमारे छात्रों के लिए बेहतरीन प्लेसमेंट के अवसर सुनिश्चित करने में बहुत सक्रिय है। अधिक जानकारी के लिए, आप हमारी प्लेसमेंट रिपोर्ट देख सकते हैं या सीडीसी से संपर्क कर सकते हैं।",
                    button1Text: "सीडीसी से संपर्क करें",
                    button1Link: "tel:+91-9876543210",
                    button2Text: "प्लेसमेंट रिपोर्ट देखें",
                    button2Link: "https://www.jietjodhpur.ac.in/placements"
                },
                "hinglish": {
                    imageUrl: "https://www.jietjodhpur.ac.in/assets/images/placement_img.jpg",
                    title: "JIET Placements aur Career Opportunities",
                    description: "JIET ka Career Development Cell (CDC) hamare students ke liye awesome placement opportunities ensure karne mein bohot active hai. Aur details ke liye, aap hamari placement report dekh sakte ho ya CDC ko contact kar sakte ho.",
                    button1Text: "CDC se Contact karein",
                    button1Link: "tel:+91-9876543210",
                    button2Text: "Placement Report Dekhein",
                    button2Link: "https://www.jietjodhpur.ac.in/placements"
                }
            },
            "fees": {
                "english": {
                    imageUrl: "https://www.jietjodhpur.ac.in/assets/images/fee_structure.jpg", // Example: Replace with an actual fees image URL from JIET
                    title: "JIET Fee Structure & Scholarships",
                    description: "Understanding fees and scholarships is important. You can find detailed information on JIET's fee structure for various programs and available scholarship programs on our website.",
                    button1Text: "Contact Admissions",
                    button1Link: "tel:+919773378530",
                    button2Text: "View Fee Details",
                    button2Link: "https://www.jietjodhpur.ac.in/admissions/fees"
                },
                "hindi": {
                    imageUrl: "https://www.jietjodhpur.ac.in/assets/images/fee_structure.jpg",
                    title: "JIET शुल्क संरचना और छात्रवृत्तियां",
                    description: "शुल्क और छात्रवृत्ति को समझना महत्वपूर्ण है। आप विभिन्न कार्यक्रमों के लिए JIET की शुल्क संरचना और हमारी वेबसाइट पर उपलब्ध छात्रवृत्ति कार्यक्रमों पर विस्तृत जानकारी प्राप्त कर सकते हैं।",
                    button1Text: "प्रवेश से संपर्क करें",
                    button1Link: "tel:+919773378530",
                    button2Text: "शुल्क विवरण देखें",
                    button2Link: "https://www.jietjodhpur.ac.in/admissions/fees"
                },
                "hinglish": {
                    imageUrl: "https://www.jietjodhpur.ac.in/assets/images/fee_structure.jpg",
                    title: "JIET Fees aur Scholarships",
                    description: "Fees aur scholarships ko samajhna important hai. Aap JIET ke various programs ki detailed fee structure aur available scholarship programs hamari website par dekh sakte hain.",
                    button1Text: "Admissions ko Contact karein",
                    button1Link: "tel:+919773378530",
                    button2Text: "Fee Details Dekhein",
                    button2Link: "https://www.jietjodhpur.ac.in/admissions/fees"
                }
            }
            // Add other categories here as needed for other info cards
        };


        /**
         * Helper function to get a random element from an array
         * @param {Array} arr - The array to pick a random element from.
         * @returns {*} A random element from the array.
         */
        function getRandomElement(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        /**
         * Detects the language of the input text (English, Hindi, or Hinglish).
         * @param {string} text - The input text from the user.
         * @returns {string} 'english', 'hindi', or 'hinglish'.
         */
        function detectLanguage(text) {
            const lowerText = text.toLowerCase();
            let englishWordCount = 0;
            let hindiWordCount = 0;
            const words = lowerText.split(/\s+/).filter(word => word.length > 0);

            const hasHindiChars = /[\u0900-\u097F]/.test(text);

            const commonEnglishKeywords = [
                "jiet", "admission", "fees", "courses", "placement", "campus", "college",
                "university", "btech", "mba", "mca", "bdes", "mbbs", "hostel", "scholarship",
                "eligibility", "exam", "program", "department", "degree", "branch", "cutoff", "what", "how", "when", "where", "which"
            ];

            const hindiHinglishKeywords = [
                "mujhe", "jaan na", "hain", "hai", "kya", "kaise", "kab", "kahan", "kitna",
                "chahiye", "batao", "bataiye", "aur", "kitne", "log", "pata", "mil jayega",
                "karwana hai", "bhare", "aayega", "baare mein", "puchna", "chahie", "ka", "ki", "me", "main", "ko",
                "karna", "hua", "hu", "hoon", "kyu", "kis", "kon"
            ];

            words.forEach(word => {
                if (commonEnglishKeywords.includes(word) || (/[a-zA-Z]/.test(word) && !hindiHinglishKeywords.includes(word))) {
                    englishWordCount++;
                }
                if (hindiHinglishKeywords.includes(word)) {
                    hindiWordCount++;
                }
            });

            if (hasHindiChars) {
                if (englishWordCount > 0) return "hinglish";
                return "hindi";
            } else {
                // If no Hindi characters, check for Hinglish by mix of romanized Hindi and English
                const totalWords = words.length;
                if (totalWords > 0 && ((hindiWordCount / totalWords > 0.3) && (englishWordCount / totalWords > 0.3))) {
                    return "hinglish";
                } else if (englishWordCount > hindiWordCount) {
                    return "english";
                } else if (hindiWordCount > englishWordCount) {
                    return "hinglish"; // Treat purely phonetic Hindi as Hinglish for interaction
                }
            }
            return "english"; // Default fallback
        }


        /**
         * Formats bot messages to include bolding, lists, and clickable links.
         * @param {string} text - The raw text from the bot.
         * @returns {string} HTML formatted text.
         */
        function formatBotMessage(text) {
            // First, process markdown for bolding and lists
            let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            const lines = html.split('\n');
            let finalHtml = '';
            let inList = false;

            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (trimmedLine.startsWith('* ') || trimmedLine.startsWith('- ')) {
                    const listItemContent = trimmedLine.substring(2).trim();
                    if (!inList) {
                        finalHtml += '<ul>';
                        inList = true;
                    }
                    finalHtml += `<li>${listItemContent}</li>`;
                } else {
                    if (inList) {
                        finalHtml += '</ul>';
                        inList = false;
                    }
                    // ONLY wrap in <p> if it's not already complex HTML like a card, link or quick replies
                    if (line.includes('<a href=') || line.includes('class="course-card"') || line.includes('quick-reply-chips')) {
                        finalHtml += line; // If it's already complex HTML (like a card or quick replies), add as is
                    } else if (trimmedLine.length > 0) {
                        // Apply link formatting only to raw URLs that aren't already part of an <a> tag
                        let processedLine = trimmedLine.replace(
                            /(https?:\/\/[^\s]+)/g,
                            '<a href="$1" target="_blank" class="text-indigo-600 hover:underline font-semibold break-all">$1</a>'
                        );
                        finalHtml += `<p>${processedLine}</p>`;
                    }
                }
            });
            if (inList) {
                finalHtml += '</ul>';
            }
            return finalHtml;
        }

        /**
         * Appends a message to the chat window.
         * @param {string} sender - 'user' or 'bot'.
         * @param {string} message - The message content (can be HTML).
         */
        function addMessage(sender, message) {
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('message', 'flex');

            let messageContentHtml;

            if (sender === 'user') {
                messageWrapper.classList.add('justify-end');
                messageContentHtml = `<p>${message}</p>`; // User messages are always plain text here
            } else { // Bot message
                messageContentHtml = formatBotMessage(message); // Format bot messages
            }

            const messageHtml = `
                ${sender === 'user' ? `<div class="mr-3 bg-indigo-600 text-white p-3 rounded-lg rounded-tr-none shadow-md max-w-[85%]">${messageContentHtml}</div>
                <div class="flex-shrink-0">
                    <div class="h-8 w-8 rounded-full bg-slate-300 flex items-center justify-center text-slate-600 font-bold text-sm">U</div>
                </div>` :
                `<div class="flex-shrink-0">
                    <div class="h-8 w-8 rounded-full bg-indigo-500 flex items-center justify-center text-white font-bold text-sm">AI</div>
                </div>
                <div class="ml-3 bg-white text-slate-800 p-3 rounded-lg rounded-tl-none shadow-md max-w-[85%]">
                    ${messageContentHtml}
                </div>`}
            `;

            messageWrapper.innerHTML = messageHtml;
            chatMessages.appendChild(messageWrapper);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        /**
         * Shows a typing indicator in the chat.
         */
        function showTypingIndicator() {
            const indicatorHtml = `
                <div id="typing-indicator" class="message flex">
                    <div class="flex-shrink-0">
                        <div class="h-8 w-8 rounded-full bg-indigo-500 flex items-center justify-center text-white font-bold text-sm">AI</div>
                    </div>
                    <div class="ml-3 bg-white text-slate-800 p-3 rounded-lg rounded-tl-none shadow-md flex items-center justify-center">
                        <div class="dot-flashing"></div>
                    </div>
                </div>
            `;
            chatMessages.insertAdjacentHTML('beforeend', indicatorHtml);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        /**
         * Removes the typing indicator from the chat.
         */
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        /**
         * Toggles the disabled state of the input and send button.
         * @param {boolean} disabled - True to disable, false to enable.
         */
        function toggleInput(disabled) {
            userInput.disabled = disabled;
            sendButton.disabled = disabled;
            if (disabled) {
                sendButton.classList.add('opacity-50', 'cursor-not-allowed');
                userInput.classList.add('bg-slate-100');
            } else {
                sendButton.classList.remove('opacity-50', 'cursor-not-allowed');
                userInput.classList.remove('bg-slate-100');
            }
        }

        /**
         * Displays quick reply chips/buttons in the chat.
         * @param {string[]} options - An array of strings for the button labels.
         * @param {string} type - 'course_type' or 'specialization' to differentiate click handlers.
         * @param {string} prompt - Text message to accompany the chips.
         */
        function showQuickReplyChips(options, type, prompt) {
            const chipsHtml = `
                <p>${prompt}</p>
                <div class="quick-reply-chips mt-2" data-type="${type}">
                    ${options.map(option => `<div class="quick-reply-chip" data-value="${option}">${option}</div>`).join('')}
                </div>
            `;
            addMessage('bot', chipsHtml); // Use addMessage to properly format the message bubble

            document.querySelectorAll('.quick-reply-chip').forEach(chip => {
                chip.onclick = handleQuickReplyClick;
            });
        }

        /**
         * Handles clicks on quick reply chips.
         * @param {Event} event - The click event.
         */
        function handleQuickReplyClick(event) {
            const chip = event.target;
            const value = chip.dataset.value;
            const chipContainer = chip.closest('.quick-reply-chips');

            // Find the parent message bubble and remove its content after selection
            const parentMessageBubble = chip.closest('.ml-3');
            if (parentMessageBubble) {
                // Keep the prompt text but remove the chips
                const promptP = parentMessageBubble.querySelector('p');
                parentMessageBubble.innerHTML = ''; // Clear existing content
                if (promptP) {
                    parentMessageBubble.appendChild(promptP); // Re-add just the prompt
                }
                chipContainer.remove(); // This line is now redundant if parentMessageBubble is cleared, but good for safety
            }


            addMessage('user', value); // Show user's selection

            toggleInput(true); // Disable input while processing
            showTypingIndicator();

            const type = chipContainer.dataset.type; // Get type AFTER potentially removing element

            if (type === 'course_type') {
                selectedCourseType = value;
                currentCourseSelectionStage = `awaiting_${value.toLowerCase()}_specialization`;

                // Get specializations for the selected course type
                const specializations = courseData[value] && courseData[value].specializations;

                if (specializations && specializations.length > 0) {
                    removeTypingIndicator();
                    showQuickReplyChips(specializations, 'specialization',
                        (detectedUserLanguage === 'hindi' ? 'किस विशेषज्ञता में रुचि रखते हैं?' :
                         detectedUserLanguage === 'hinglish' ? 'Kis specialization mein interested ho?' :
                         'Which specialization are you interested in?')
                    );
                    toggleInput(false); // Re-enable input after showing new chips
                } else {
                    // No specializations, directly provide info for the main course type
                    provideCourseInfo(value);
                    toggleInput(false);
                    currentCourseSelectionStage = null; // Reset stage
                    selectedCourseType = null;
                }
            } else if (type === 'specialization') {
                // This is a specialization. selectedCourseType should already be set.
                provideCourseInfo(selectedCourseType, value);
                toggleInput(false);
                currentCourseSelectionStage = null; // Reset stage
                selectedCourseType = null;
            }
        }

        /**
         * Provides detailed course information based on selected course type and specialization.
         * @param {string} courseType - The main course type (e.g., 'B.Tech', 'MBA').
         * @param {string} [specialization] - The specific specialization (optional).
         */
        function provideCourseInfo(courseType, specialization = null) {
            removeTypingIndicator();
            const courseInfo = courseData[courseType];
            const langInfo = courseInfo[detectedUserLanguage];
            let response = `${langInfo.intro}`;

            if (specialization && courseType === "B.Tech") {
                const placementInfo = langInfo.placements[specialization] || (detectedUserLanguage === 'hindi' ? "इस विशेषज्ञता के लिए कोई विशिष्ट प्लेसमेंट डेटा उपलब्ध नहीं है, लेकिन कुल मिलाकर बी.टेक प्लेसमेंट मजबूत हैं।" : detectedUserLanguage === 'hinglish' ? "Is specialization ke liye koi specific placement data available nahi hai, par overall B.Tech placements strong hain." : "No specific placement data available for this specialization, but overall B.Tech placements are strong.");
                response += `\n\nFor **${specialization}**:`;
                response += `\n- **Average Placement:** ${placementInfo}`;
            }

            response += `\n- **Fees (1st Year):** ${langInfo.fees}`;
            response += `\n- **Eligibility:** ${langInfo.eligibility}`;

            // Add scholarship info if available
            // Note: Your scholarship data in the knowledge base is a bit flat,
            // so this logic is an approximation. For more precise data,
            // you'd need to expand the `courseData` structure for scholarships.
            let scholarshipText = "";
            if (courseType === "B.Tech") {
                if (specialization === "CSE" || specialization === "AI & ML" || specialization === "Data Science" || specialization === "Cyber Security") {
                    scholarshipText = (detectedUserLanguage === 'hindi' ? "जेईई मेन में 90 परसेंटाइल या 12वीं में >=90% पर छात्रवृत्ति उपलब्ध है।" : detectedUserLanguage === 'hinglish' ? "JEE Main mein 90 Percentile ya 12th mein >=90% par scholarship available hai." : "Scholarship available for >=90 Percentile in JEE Main or >=90% in Class 12th.");
                } else if (["ME", "CE", "EE", "ECE"].includes(specialization)) {
                    scholarshipText = (detectedUserLanguage === 'hindi' ? "12वीं में >=60% पर 4 साल के लिए ₹40,000 की छात्रवृत्ति, <60% पर ₹25,000।" : detectedUserLanguage === 'hinglish' ? "12th mein >=60% par 4 saal ke liye ₹40,000 scholarship, <60% par ₹25,000." : "Scholarship of ₹40,000 for 4 years with >=60% in Class 12th, ₹25,000 for <60%.");
                }
            } else if (courseType === "B.Des") {
                scholarshipText = (detectedUserLanguage === 'hindi' ? "12वीं में >=60% पर 4 साल के लिए ₹40,000 की छात्रवृत्ति, <60% पर ₹25,000।" : detectedUserLanguage === 'hinglish' ? "12th mein >=60% par 4 saal ke liye ₹40,000 scholarship, <60% par ₹25,000." : "Scholarship of ₹40,000 for 4 years with >=60% in Class 12th, ₹25,000 for <60%.");
            } else if (courseType === "BBA" || courseType === "BCA") {
                scholarshipText = (detectedUserLanguage === 'hindi' ? "12वीं में >=60% पर 3 साल के लिए ₹25,000 की छात्रवृत्ति, <60% पर ₹15,000।" : detectedUserLanguage === 'hinglish' ? "12th mein >=60% par 3 saal ke liye ₹25,000 scholarship, <60% par ₹15,000." : "Scholarship of ₹25,000 for 3 years with >=60% in Class 12th, ₹15,000 for <60%.");
            } else if (courseType === "MBA" || courseType === "MCA") {
                scholarshipText = (detectedUserLanguage === 'hindi' ? "स्नातक में >=80% पर ₹15,000 की एकमुश्त छात्रवृत्ति।" : detectedUserLanguage === 'hinglish' ? "Graduation mein >=80% par ₹15,000 ki one-time scholarship." : "One-time scholarship of ₹15,000 for >=80% in Graduation.");
            } else if (courseType === "M.Tech") {
                scholarshipText = (detectedUserLanguage === 'hindi' ? "सभी प्रवेश प्राप्त छात्रों को दोनों वर्षों के लिए ₹25,000 की छात्रवृत्ति।" : detectedUserLanguage === 'hinglish' ? "Sabhi admitted students ko dono saalon ke liye ₹25,000 scholarship." : "All admitted students receive a ₹25,000 scholarship for both years.");
            } else if (courseType === "B.Sc (H&HA)") {
                 scholarshipText = (detectedUserLanguage === 'hindi' ? "12वीं में >=60% पर 3 साल के लिए ₹40,000 की छात्रवृत्ति, <60% पर ₹25,000।" : detectedUserLanguage === 'hinglish' ? "12th mein >=60% par 3 saal ke liye ₹40,000 scholarship, <60% par ₹25,000." : "Scholarship of ₹40,000 for 3 years with >=60% in Class 12th, ₹25,000 for <60%.");
            }

            if (scholarshipText) {
                response += `\n- **Scholarship:** ${scholarshipText}`;
            }

            response += `\n\n${getRandomElement(closingPhrases[detectedUserLanguage])}`;
            addMessage('bot', response);
            toggleInput(false);
            userInput.focus();
        }

        /**
         * Generates and adds a generic information card to the chat.
         * @param {string} lang - The detected language ('english', 'hindi', 'hinglish').
         * @param {object} cardData - Object containing image, title, description, and button links.
         * Example: {
         * imageUrl: "https://example.com/image.png",
         * title: "Courses Offered",
         * description: "Here are some courses...",
         * button1Text: "Contact Us",
         * button1Link: "tel:+919773378530",
         * button2Text: "Learn More",
         * button2Link: "https://www.jietjodhpur.ac.in/"
         * }
         */
        function showInfoCard(lang, cardData) {
            const cardHtml = `
                <div class="course-card">
                    ${cardData.imageUrl ? `<img src="${cardData.imageUrl}" alt="${cardData.title}" class="course-card-image">` : ''}
                    <div class="course-card-content">
                        <h3 class="text-lg font-semibold text-slate-900 mb-2">${cardData.title}</h3>
                        <p class="text-sm text-slate-700">${cardData.description}</p>
                    </div>
                    <div class="course-card-buttons">
                        ${cardData.button1Text && cardData.button1Link ? `<a href="${cardData.button1Link}" target="${cardData.button1Link.startsWith('tel:') ? '_self' : '_blank'}" class="contact-btn">${cardData.button1Text}</a>` : ''}
                        ${cardData.button2Text && cardData.button2Link ? `<a href="${cardData.button2Link}" target="_blank" class="know-more-btn">${cardData.button2Text}</a>` : ''}
                    </div>
                </div>
            `;
            addMessage('bot', cardHtml);
        }


        /**
         * Handles sending a message, calling the AI, and displaying the response.
         */
        async function handleSendMessage() {
            const userMessage = userInput.value.trim();
            if (userMessage === '') return;

            addMessage('user', userMessage);
            userInput.value = '';
            toggleInput(true);
            showTypingIndicator();

            // Detect language of the user's message
            detectedUserLanguage = detectLanguage(userMessage); // Update global variable

            // Check if we are in a course selection flow (meaning user typed instead of clicking chip)
            if (currentCourseSelectionStage) {
                removeTypingIndicator();
                let guideMessage;
                if (detectedUserLanguage === 'hindi') {
                    guideMessage = `कृपया ऊपर दिए गए विकल्पों में से चुनें या फिर से 'कोर्स' टाइप करके विकल्पों को पुनः प्राप्त करें।`;
                } else if (detectedUserLanguage === 'hinglish') {
                    guideMessage = `Please upar diye gaye options mein se choose karein ya phir se 'courses' type karke options ko wapas le aayein.`;
                } else {
                    guideMessage = `Please select from the options provided above, or type 'courses' again to re-display the options.`;
                }
                addMessage('bot', guideMessage);
                toggleInput(false);
                userInput.focus();
                return;
            }


            const lowerMessage = userMessage.toLowerCase();

            // --- Keyword Checks for Card Display ---

            // Handle "Courses" related queries using the new card structure
            const courseKeywords = [
                "course", "courses", "program", "programs", "degree", "degrees",
                "branch", "branches", "specialization", "specializations", "study",
                "padhai", "konsa course", "course ke baare mein", "courses offered",
                "degrees offered", "kis course mein admission", "kon se courses", "kya padhai hoti hai"
            ];

            if (courseKeywords.some(keyword => lowerMessage.includes(keyword))) {
                removeTypingIndicator();
                showInfoCard(detectedUserLanguage, jietCardData.courses[detectedUserLanguage]);

                const promptMessage = (detectedUserLanguage === 'hindi' ? 'किस प्रकार का कोर्स जानना चाहेंगे?' :
                                       detectedUserLanguage === 'hinglish' ? 'Kis type ka course jaanna chahoge?' :
                                       'Which type of course would you like to know about?');
                showQuickReplyChips(mainCourseTypes, 'course_type', promptMessage);

                currentCourseSelectionStage = 'awaiting_course_type';
                toggleInput(false);
                userInput.focus();
                return;
            }

            // Handle "Placements" related queries using the new card structure
            const placementKeywords = [
                "placement", "placements", "salary", "package", "job", "jobs", "company",
                "companies", "recruiters", "career", "rojgar", "nokri", "placement kaise hota hai",
                "placement statistics", "average package", "highest package"
            ];

            if (placementKeywords.some(keyword => lowerMessage.includes(keyword))) {
                removeTypingIndicator();
                if (jietCardData.placements && jietCardData.placements[detectedUserLanguage]) {
                    showInfoCard(detectedUserLanguage, jietCardData.placements[detectedUserLanguage]);
                } else {
                    addMessage('bot', notFoundPhrases[detectedUserLanguage]);
                }
                toggleInput(false);
                userInput.focus();
                return;
            }

            // Handle "Fees" related queries using the new card structure
            const feesKeywords = [
                "fees", "fee", "cost", "scholarship", "scholarships", "charge", "charges",
                "kitne paise", "kitni fees hai", "fee structure", "fee jankari"
            ];

            if (feesKeywords.some(keyword => lowerMessage.includes(keyword))) {
                removeTypingIndicator();
                if (jietCardData.fees && jietCardData.fees[detectedUserLanguage]) {
                    showInfoCard(detectedUserLanguage, jietCardData.fees[detectedUserLanguage]);
                } else {
                    addMessage('bot', notFoundPhrases[detectedUserLanguage]);
                }
                toggleInput(false);
                userInput.focus();
                return;
            }

            // --- Existing Keyword Checks (for direct text responses) ---

            const registrationKeywords = [
                "registration", "register", "admission",
                "form bharna", "form fill", "apply",
                "apply karna hai", "admission lena hai",
                "registration karwana hai", "form kaise bhare",
                "form kab aayega", "form kaha bhare"
            ];

            if (registrationKeywords.some(keyword => lowerMessage.includes(keyword))) {
                removeTypingIndicator();
                const selectedAdmissionPhrase = getRandomElement(admissionPhrases[detectedUserLanguage]);
                const responseText = `
                    <p>${selectedAdmissionPhrase}</p>
                    <p><a href="https://admissions.jietjodhpur.ac.in/" target="_blank" class="text-indigo-600 font-semibold hover:underline">https://admissions.jietjodhpur.ac.in/</a></p>
                    <p class="mt-2">${getRandomElement(closingPhrases[detectedUserLanguage].map(p => p.replace("Hope this helps!", "If you need any help filling out the form, feel free to ask! 😊").replace("Glad I could help!", "Let me know if you have more questions about the process!")))}</p>
                `;
                addMessage('bot', responseText);
                toggleInput(false);
                userInput.focus();
                return;
            }

            const addressKeywords = ["address", "location", "map", "pata", "kahan hai", "kaha par hai"];

            if (addressKeywords.some(keyword => lowerMessage.includes(keyword))) {
                removeTypingIndicator();

                const selectedAddressPhrase = getRandomElement(addressPhrases[detectedUserLanguage]);
                const responseText = `
                    <p>${selectedAddressPhrase}</p>
                    <p class="mt-1">JIET Universe, NH-62, Jodhpur Pali Highway,<br>Village Mogra, Jodhpur - 342802</p>
                    <p class="mt-3 text-sm text-slate-700">You can find us easily on Google Maps here:</p>
                    <p><a href="https://www.google.com/maps/search/?api=1&query=JIET+Universe+Jodhpur" target="_blank" class="text-indigo-600 font-semibold hover:underline">View on Google Maps 🗺️</a></p>
                `;
                addMessage('bot', responseText);
                toggleInput(false);
                userInput.focus();
                return;
            }

            // --- Fallback to Gemini API if no specific keyword match ---
            chatHistory.push({ role: "user", parts: [{ text: userMessage }] });

            const systemInstructionText = `
                You are the JIET Assistant, a friendly and helpful AI chatbot for the Jodhpur Institute of Engineering and Technology (JIET Universe).
                Your main goal is to answer user questions accurately based *only* on the provided knowledge base.
                Please use a **conversational, approachable, and friendly tone**, almost like talking to a friend.
                Vary your phrasing and sentence structures to avoid sounding repetitive.
                Feel free to use **emojis** where appropriate to add to the friendly tone.
                The user has sent their query in **${detectedUserLanguage}**. Please respond in the same language:
                - If the user types in **pure English**, respond in **pure English**.
                - If the user types in **pure Hindi (Devanagari script)**, respond in **pure Hindi**.
                - If the user types in **Hinglish (mix of Romanized Hindi and English words)**, respond in **Hinglish**.

                If the answer is not in the knowledge base, you MUST respond by politely stating you don't have the information in your current data, and then provide a direct, clickable link to the official JIET website: https://www.jietjodhpur.ac.in/.
                Always try to end your response with a friendly closing or an encouraging question.

                Here is the knowledge base:
                ` + jietKnowledgeBase;

            const payload = {
                contents: chatHistory,
                systemInstruction: {
                    parts: [{ text: systemInstructionText }]
                }
            };

            const apiKey = "AIzaSyDvYU3qMbaHVmGLVtZZi9Bx6HqYld6aTP4"; // <<<<<<< IMPORTANT: REPLACE WITH YOUR ACTUAL GEMINI API KEY >>>>>>>
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("API Error Response:", errorBody);
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const result = await response.json();
                removeTypingIndicator();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {

                    const botResponse = result.candidates[0].content.parts[0].text;
                    addMessage('bot', botResponse);
                    chatHistory.push(result.candidates[0].content);
                } else {
                    addMessage('bot', notFoundPhrases[detectedUserLanguage]);
                    console.error('Unexpected API response structure:', result);
                }

            } catch (error) {
                removeTypingIndicator();
                addMessage('bot', apiErrorPhrases[detectedUserLanguage]);
                console.error('Error fetching from Gemini API:', error);
            } finally {
                toggleInput(false);
                userInput.focus();
            }
        }

        // --- Event Listeners ---
        sendButton.addEventListener('click', handleSendMessage);
        userInput.addEventListener('keypress', function (event) {
            if (event.key === 'Enter') {
                handleSendMessage();
            }
        });

        // Initialize with a friendly welcome message
        document.addEventListener('DOMContentLoaded', () => {
            const initialWelcomeMessageElement = document.querySelector('#chat-messages .message p');
            if (initialWelcomeMessageElement) {
                const defaultLang = "english";
                initialWelcomeMessageElement.innerHTML = getRandomElement(friendlyGreetings[defaultLang]) + ` I'm your JIET Assistant, here to help with questions about admissions, courses, fees, placements, and campus life at JIET Universe. How can I assist you today? ✨`;
            }
        });

        // Different friendly greetings for the bot
        const friendlyGreetings = {
            "english": [
                "Hey there! 👋",
                "Hi! How can I help you today? 😊",
                "Hello! What's on your mind about JIET? 🤔",
                "Hey! Ready to dive into JIET info? 🚀"
            ],
            "hindi": [
                "नमस्ते! मैं JIET असिस्टेंट हूँ। 👋",
                "नमस्कार! मैं आपकी कैसे मदद कर सकता हूँ? 😊",
                "नमस्ते! JIET के बारे में क्या जानना चाहते हैं? 🤔",
                "अरे! JIET जानकारी में गोता लगाने के लिए तैयार हैं? 🚀"
            ],
            "hinglish": [
                "Hey there! Kaise ho? 👋",
                "Hi! Main apki kaise help kar sakta hu? 😊",
                "Hello! Kya chal raha hai JIET ke baare mein? 🤔",
                "Arre! JIET info ke liye ready ho? 🚀"
            ]
        };

        // Different ways to phrase the admissions response
        const admissionPhrases = {
            "english": [
                "Great question! You can kickstart your JIET journey by heading over to our official admissions portal. It's super easy! Check it out here:",
                "Looking to join JIET? Awesome! 🙌 You can complete your registration and apply for admission directly on our official website. Here's the link:",
                "Thinking about admissions at JIET? You're in the right place! ✨ Just click on this link to start your application:",
                "To get started with your JIET registration and admission, simply visit our dedicated portal. We've made it simple for you:",
                "Planning to apply to JIET? Fantastic! 🤩 The online registration is quick and easy. Find the portal here:"
            ],
            "hindi": [
                "बहुत अच्छा सवाल! आप हमारे आधिकारिक प्रवेश पोर्टल पर जाकर अपनी JIET यात्रा शुरू कर सकते हैं। यह बहुत आसान है! यहाँ देखें:",
                "JIET में शामिल होना चाहते हैं? बहुत बढ़िया! 🙌 आप हमारी आधिकारिक वेबसाइट पर सीधे अपना पंजीकरण और प्रवेश के लिए आवेदन कर सकते हैं। यहाँ लिंक है:",
                "JIET में प्रवेश के बारे में सोच रहे हैं? आप सही जगह पर हैं! ✨ अपना आवेदन शुरू करने के लिए बस इस लिंक पर क्लिक करें:",
                "अपने JIET पंजीकरण और प्रवेश के साथ शुरू करने के लिए, बस हमारे समर्पित पोर्टल पर जाएं। हमने इसे आपके लिए सरल बना दिया है:",
                "JIET में आवेदन करने की योजना बना रहे हैं? शानदार! 🤩 ऑनलाइन पंजीकरण त्वरित और आसान है। पोर्टल यहाँ खोजें:"
            ],
            "hinglish": [
                "Great question! Aap apni JIET journey hamare official admissions portal par jaa kar start kar sakte hain. Bohut easy hai! Yahan dekho:",
                "JIET join karna hai? Awesome! 🙌 Aap apna registration aur admission ke liye hamari official website par apply kar sakte hain. Link yahan hai:",
                "Thinking about admissions at JIET? Sahi jagah ho! ✨ Bus is link par click karo aur apna application start karo:",
                "JIET registration aur admission ke liye, hamare dedicated portal par jao. Humne isse simple bana diya hai aapke liye:",
                "Planning to apply to JIET? Fantastic! 🤩 Online registration bohut quick aur easy hai. Portal yahan milega:"
            ]
        };

        // Different ways to phrase the address response
        const addressPhrases = {
            "english": [
                "Of course! Here's where you can find JIET Universe:",
                "Looking for us? Here's our address at JIET Universe. We'd love to see you! 👇",
                "You got it! JIET Universe is located at:",
                "Absolutely! Our campus, JIET Universe, is situated at:"
            ],
            "hindi": [
                "बिल्कुल! JIET यूनिवर्स यहाँ स्थित है:",
                "हमें ढूंढ रहे हैं? JIET यूनिवर्स का हमारा पता यहाँ है। हम आपसे मिलकर बहुत खुश होंगे! 👇",
                "हाँ! JIET यूनिवर्स यहाँ स्थित है:",
                "निश्चित रूप से! हमारा कैंपस, JIET यूनिवर्स, यहाँ स्थित है:"
            ],
            "hinglish": [
                "Of course! JIET Universe yahan milega:",
                "Humein dhundh rahe ho? JIET Universe ka address yahan hai. Humein aapse milkar khushi hogi! 👇",
                "Haan! JIET Universe yahan located hai:",
                "Absolutely! Humara campus, JIET Universe, is situated at:"
            ]
        };

        const closingPhrases = {
            "english": [
                "Hope this helps! Is there anything else I can assist you with today? 😊",
                "Glad I could help! Feel free to ask if you have more questions. ✨",
                "Let me know if you need anything else! Happy to assist. 👍",
                "Is there anything else you'd like to know about JIET? I'm here to help! 🚀"
            ],
            "hindi": [
                "आशा है यह आपकी मदद करेगा! क्या मैं आज आपकी किसी और चीज़ में मदद कर सकता हूँ? 😊",
                "मुझे खुशी है कि मैं मदद कर सका! यदि आपके कोई और प्रश्न हैं तो बेझिझक पूछें। ✨",
                "अगर आपको कुछ और चाहिए तो मुझे बताएं! मदद करने में खुशी होगी। 👍",
                "क्या आप JIET के बारे में कुछ और जानना चाहेंगे? मैं मदद के लिए यहाँ हूँ! 🚀"
            ],
            "hinglish": [
                "Hope this helps! Aur kuch puchna hai aaj? 😊",
                "Khushi hui help karke! Aur questions hon toh puch lena. ✨",
                "Bata dena agar kuch aur chahiye! Help karke khushi hogi. 👍",
                "JIET ke bare mein aur kuch jaanna hai? Main yahan hu help ke liye! 🚀"
            ]
        };

        const notFoundPhrases = {
            "english": `Oops! I couldn't find an answer for that right now in my knowledge base. Maybe try rephrasing? You can also check out the <a href='https://www.jietjodhpur.ac.in/' target='_blank' class='text-indigo-600 font-semibold hover:underline'>official JIET website</a> for more info. 😊`,
            "hindi": `क्षमा करें! मुझे अभी इस प्रश्न का उत्तर मेरे ज्ञानकोष में नहीं मिल पा रहा है। शायद आप इसे अलग तरीके से पूछ सकते हैं? अधिक जानकारी के लिए आप <a href='https://www.jietjodhpur.ac.in/' target='_blank' class='text-indigo-600 font-semibold hover:underline'>आधिकारिक JIET वेबसाइट</a> भी देख सकते हैं। 😊`,
            "hinglish": `Oops! Mujhe iska answer abhi meri knowledge base mein nahi mila. Shayad aap isse rephrase karke puch sakte hain? Aur zyada info ke liye aap <a href='https://www.jietjodhpur.ac.in/' target='_blank' class='text-indigo-600 font-semibold hover:underline'>official JIET website</a> bhi check kar sakte hain. 😊`
        };

        const apiErrorPhrases = {
            "english": `Oh no! It looks like something went wrong on my end. 😔 Please check your internet connection or try asking again in a bit. You can always visit the <a href='https://www.jietjodhpur.ac.in/' target='_blank' class='text-indigo-600 font-semibold hover:underline'>official JIET website</a> for details!`,
            "hindi": `ओह नहीं! लगता है मेरे सिस्टम में कुछ गड़बड़ हो गई है। 😔 कृपया अपना इंटरनेट कनेक्शन जांचें या थोड़ी देर बाद फिर से पूछें। आप विवरण के लिए हमेशा <a href='https://www.jietjodhpur.ac.in/' target='_blank' class='text-indigo-600 font-semibold hover:underline'>आधिकारिक JIET वेबसाइट</a> पर जा सकते हैं!`,
            "hinglish": `Oh no! Lagta hai mere side se kuch gadbad ho gayi hai. 😔 Please apna internet connection check karo ya thodi der baad phir se puchna. Aap details ke liye hamesha <a href='https://www.jietjodhpur.ac.in/' target='_blank' class='text-indigo-600 font-semibold hover:underline'>official JIET website</a> visit kar sakte hain!`
        };
    </script>
</body>

</html>
